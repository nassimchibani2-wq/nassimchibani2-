<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nassim Chat V4.0 - Fixed & Final</title>
    <style>
        :root { --wa-green: #075e54; --wa-light: #25d366; --bg: #f0f2f5; --white: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--wa-green); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #auth-screen { background: var(--white); padding: 30px; border-radius: 25px; width: 85%; max-width: 400px; margin: auto; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 1000; }
        .input-box { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; text-align: right; font-size: 16px; }
        .btn-main { background: var(--wa-light); color: white; border: none; padding: 14px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        /* Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        #main-app { display: none; height: 100%; background: var(--bg); flex-direction: column; width: 100%; }
        .header { background: var(--wa-green); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .content-area { flex: 1; overflow-y: auto; padding-bottom: 80px; }
        .page { display: none; padding: 15px; }
        .page.active { display: block; }

        /* Ø§Ù„Ø¹Ù†Ø§ØµØ± */
        .chat-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .fab { position: fixed; bottom: 85px; left: 20px; width: 55px; height: 55px; background: var(--wa-green); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 99; }

        /* Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ */
        .profile-container { position: relative; width: 100px; height: 100px; margin: 0 auto 15px; }
        #p-img { width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--wa-light); object-fit: cover; background: #eee; }
        .add-photo-label { position: absolute; bottom: 0; right: 0; background: var(--wa-green); color: white; width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; font-weight: bold; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; padding: 10px 0; height: 70px; }
        .nav-item { flex: 1; text-align: center; color: #666; cursor: pointer; font-size: 0.8rem; }
        .nav-item.active { color: var(--wa-green); font-weight: bold; }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; }
        .modal-content { background:white; width:85%; max-width:350px; padding:20px; border-radius:20px; text-align: center; }
        .type-option { padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin: 8px 0; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h2 id="auth-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <div id="login-form">
            <input type="text" id="log-user" class="input-box" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input type="password" id="log-pass" class="input-box" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="btn-main" id="login-action">Ø¯Ø®ÙˆÙ„</button>
            <p style="color:var(--wa-green); cursor:pointer; font-weight:bold; margin-top:15px;" onclick="toggleAuth(true)">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</p>
        </div>
        <div id="signup-form" style="display:none">
            <input type="text" id="reg-user" class="input-box" placeholder="Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯">
            <input type="text" id="reg-contact" class="input-box" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ">
            <input type="password" id="reg-pass" class="input-box" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="btn-main" id="register-action">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
            <p style="color:#666; cursor:pointer; margin-top:15px;" onclick="toggleAuth(false)">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¯Ø®ÙˆÙ„</p>
        </div>
    </div>

    <div id="main-app">
        <div class="header"><span id="header-title">Ø¯Ø±Ø¯Ø´Ø© Ù†Ø³ÙŠÙ…</span><span>ğŸ” â‹®</span></div>
        
        <div class="content-area">
            <div id="page-chats" class="page active">
                <div id="chat-items-container">
                    <div class="chat-item">ğŸ¤– <b>Ù…Ø³Ø§Ø¹Ø¯ Ù†Ø³ÙŠÙ… Ø§Ù„Ø°ÙƒÙŠ</b></div>
                </div>
                <div class="fab" onclick="openModal('modal-add-chat')">+</div>
            </div>

            <div id="page-calls" class="page">
                <div id="call-items-container">
                    <p style="color:#888; text-align:center; margin-top:50px;">Ø³Ø¬Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ ÙØ§Ø±Øº</p>
                </div>
                <div class="fab" onclick="openModal('modal-add-call')">ğŸ“</div>
            </div>

            <div id="page-profile" class="page">
                <div class="profile-container">
                    <img src="https://via.placeholder.com/150" id="p-img">
                    <label for="img-input" class="add-photo-label">+</label>
                    <input type="file" id="img-input" style="display:none" accept="image/*">
                </div>
                <h2 id="display-name">Ù…Ø·ÙˆØ± Ù†Ø³ÙŠÙ…</h2>
                <p id="display-info">nassim@mail.com</p>
                <button class="btn-main" style="background:var(--wa-green)" onclick="openModal('modal-edit-profile')">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
                <button class="btn-main" style="background:#e74c3c" onclick="location.reload()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="navTo('page-chats', this, 'Ø¯Ø±Ø¯Ø´Ø© Ù†Ø³ÙŠÙ…')">ğŸ’¬<br>Ø¯Ø±Ø¯Ø´Ø©</div>
            <div class="nav-item" onclick="navTo('page-calls', this, 'Ø§ØªØµØ§Ù„')">ğŸ“<br>Ø§ØªØµØ§Ù„</div>
            <div class="nav-item" onclick="navTo('page-profile', this, 'Ø­Ø³Ø§Ø¨ÙŠ')">ğŸ‘¤<br>Ø­Ø³Ø§Ø¨ÙŠ</div>
        </div>
    </div>

    <div id="modal-add-chat" class="modal"><div class="modal-content">
        <h3>Ù†ÙˆØ¹ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h3>
        <div class="type-option" onclick="alert('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ')">ğŸ¤– Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>
        <div class="type-option" onclick="const s = prompt('Ø§Ø³Ù… Ø§Ù„ØµØ¯ÙŠÙ‚:'); if(s) alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ù„Ù€ ' + s)">ğŸ‘¥ Ø«Ù†Ø§Ø¦ÙŠØ©</div>
        <div class="type-option" onclick="const c = Math.random().toString(36).substr(2,5).toUpperCase(); alert('ÙƒÙˆØ¯ Ù…Ø¬Ù…ÙˆØ¹ØªÙƒ: ' + c)">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Ø¬Ù…Ø§Ø¹ÙŠØ© (ÙƒÙˆØ¯)</div>
        <button class="btn-main" style="background:#888" onclick="closeModal('modal-add-chat')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div></div>

    <div id="modal-add-call" class="modal"><div class="modal-content">
        <h3>Ø¥Ø¶Ø§ÙØ© Ø§ØªØµØ§Ù„ Ø³Ø±ÙŠØ¹</h3>
        <input type="text" id="call-val" class="input-box" placeholder="Ø§Ø³Ù…ØŒ Ù‡Ø§ØªÙØŒ Ø£Ùˆ Ø¨Ø±ÙŠØ¯">
        <button class="btn-main" onclick="addShortCall()">Ø¥Ø¶Ø§ÙØ©</button>
        <button class="btn-main" style="background:#888" onclick="closeModal('modal-add-call')">Ø¥Ù„ØºØ§Ø¡</button>
    </div></div>

    <div id="modal-edit-profile" class="modal"><div class="modal-content">
        <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <input type="text" id="edit-n" class="input-box" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">
        <input type="text" id="edit-c" class="input-box" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯/Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
        <input type="password" id="edit-p" class="input-box" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©">
        <button class="btn-main" id="save-edit-action">Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹</button>
        <button class="btn-main" style="background:#888" onclick="closeModal('modal-edit-profile')">Ø¥Ù„ØºØ§Ø¡</button>
    </div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCKpluKshSHwGSfRwtA-P-oY7y8mXoT_6I",
            authDomain: "nassim-app-919fe.firebaseapp.com",
            databaseURL: "https://nassim-app-919fe-default-rtdb.firebaseio.com",
            projectId: "nassim-app-919fe",
            storageBucket: "nassim-app-919fe.appspot.com",
            messagingSenderId: "575511230749",
            appId: "1:575511230749:web:b315423db6972675ea09f4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø¯Ø®ÙˆÙ„ / ØªØ³Ø¬ÙŠÙ„) ---
        document.getElementById('register-action').onclick = async () => {
            const u = document.getElementById('reg-user').value;
            const c = document.getElementById('reg-contact').value;
            const p = document.getElementById('reg-pass').value;
            if(u && p) {
                await set(ref(db, 'users/' + u), { contact: c, password: p, photo: "" });
                alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
                toggleAuth(false);
            }
        };

        document.getElementById('login-action').onclick = async () => {
            const u = document.getElementById('log-user').value;
            const p = document.getElementById('log-pass').value;
            if(u === "Ù…Ø·ÙˆØ± Ù†Ø³ÙŠÙ…" && p === "123456") { startApp(u, "nassim@mail.com", ""); }
            else {
                const snap = await get(child(ref(db), `users/${u}`));
                if(snap.exists() && snap.val().password === p) {
                    startApp(u, snap.val().contact, snap.val().photo);
                } else { alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©!"); }
            }
        };

        // --- ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ---
        document.getElementById('save-edit-action').onclick = async () => {
            const user = document.getElementById('display-name').innerText;
            const n = document.getElementById('edit-n').value;
            const c = document.getElementById('edit-c').value;
            const p = document.getElementById('edit-p').value;
            const data = {};
            if(n) { data.name = n; document.getElementById('display-name').innerText = n; }
            if(c) { data.contact = c; document.getElementById('display-info').innerText = c; }
            if(p) data.password = p;
            await set(ref(db, 'users/' + user), data);
            alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹!"); closeModal('modal-edit-profile');
        };

        // --- Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ---
        document.getElementById('img-input').onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = async () => {
                const base64 = reader.result;
                document.getElementById('p-img').src = base64;
                await set(ref(db, 'users/' + document.getElementById('display-name').innerText + '/photo'), base64);
            };
            reader.readAsDataURL(file);
        };

        function startApp(n, i, p) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            document.getElementById('display-name').innerText = n;
            document.getElementById('display-info').innerText = i;
            if(p) document.getElementById('p-img').src = p;
        }
    </script>

    <script>
        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ ÙˆØ§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª) ---
        function toggleAuth(isReg) {
            document.getElementById('login-form').style.display = isReg ? 'none' : 'block';
            document.getElementById('signup-form').style.display = isReg ? 'block' : 'none';
            document.getElementById('auth-title').innerText = isReg ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨' : 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        }
        function navTo(pageId, el, title) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            el.classList.add('active');
            document.getElementById('header-title').innerText = title;
        }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function addShortCall() {
            const v = document.getElementById('call-val').value;
            if(v) {
                document.getElementById('call-items-container').innerHTML += `<div class="chat-item">ğŸ“ <b>${v}</b></div>`;
                closeModal('modal-add-call');
            }
        }
    </script>
</body>
</html>
